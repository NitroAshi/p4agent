stages:
  - parse
  - task
  - quality
  - diff
  - mr
  - notify

workflow:
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/'
    - when: never

default:
  image: python:3.12
  before_script:
    - pip install --disable-pip-version-check uv
    - uv sync --all-extras

parse_agent_command:
  stage: parse
  script:
    - uv run python -m app.agent_pr_command --comment "$AGENT_COMMAND" --output-file agent.env --output-format dotenv
  artifacts:
    reports:
      dotenv: agent.env

reply_invalid_command:
  stage: notify
  needs: ["parse_agent_command"]
  rules:
    - if: '$VALID != "true" && $AGENT_ISSUE_IID && $GITLAB_TOKEN'
  script:
    - |
      curl --fail --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --data-urlencode "body=I could not parse this command.

Reason: ${ERROR_MESSAGE}

Use this format:
/agent-pr append_hello_agent_comment ./aaa.txt" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues/${AGENT_ISSUE_IID}/notes"

run_task:
  stage: task
  needs: ["parse_agent_command"]
  rules:
    - if: '$VALID == "true"'
  script:
    - uv run p4agent-cli --task-id "$TASK_ID" --target-file "$TARGET_FILE"

quality_checks:
  stage: quality
  needs: ["run_task"]
  rules:
    - if: '$VALID == "true"'
  script:
    - uv run ruff format --check .
    - uv run ruff check .
    - uv run mypy src tests
    - uv run pytest

detect_changes:
  stage: diff
  needs: ["quality_checks", "parse_agent_command"]
  rules:
    - if: '$VALID == "true"'
  script:
    - |
      if git diff --quiet; then
        echo "CHANGED=false" > change.env
      else
        echo "CHANGED=true" > change.env
      fi
  artifacts:
    reports:
      dotenv: change.env

reply_no_changes:
  stage: notify
  needs: ["detect_changes", "parse_agent_command"]
  rules:
    - if: '$VALID == "true" && $CHANGED != "true" && $AGENT_ISSUE_IID && $GITLAB_TOKEN'
  script:
    - |
      curl --fail --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --data-urlencode "body=Task ran successfully, but no file changes were detected.

task_id: ${TASK_ID}
target_file: ${TARGET_FILE}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues/${AGENT_ISSUE_IID}/notes"

create_merge_request:
  stage: mr
  needs: ["detect_changes", "parse_agent_command"]
  rules:
    - if: '$VALID == "true" && $CHANGED == "true" && $GITLAB_TOKEN'
  script:
    - export BRANCH_NAME="codex/issue-${AGENT_ISSUE_IID:-manual}-${CI_PIPELINE_ID}"
    - git config user.name "p4agent-bot"
    - git config user.email "p4agent-bot@example.com"
    - git checkout -b "${BRANCH_NAME}"
    - git add -A
    - git commit -m "feat(agent): run ${TASK_ID} on ${TARGET_FILE}"
    - export REMOTE_URL="https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git push "${REMOTE_URL}" "HEAD:${BRANCH_NAME}"
    - |
      response=$(curl --fail --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --data-urlencode "source_branch=${BRANCH_NAME}" \
        --data-urlencode "target_branch=${CI_DEFAULT_BRANCH}" \
        --data-urlencode "title=Draft: agent: ${TASK_ID} for #${AGENT_ISSUE_IID:-manual}" \
        --data-urlencode "description=## Summary
- Triggered by AGENT_COMMAND in GitLab CI.
- Task: \`${TASK_ID}\`
- Target: \`${TARGET_FILE}\`

## Validation
- [x] \`uv run ruff format --check .\`
- [x] \`uv run ruff check .\`
- [x] \`uv run mypy src tests\`
- [x] \`uv run pytest\`

## Source
- Pipeline: ${CI_PIPELINE_URL}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests")
      printf '%s' "$response" | python3 -c 'import json,sys; data=json.loads(sys.stdin.read()); print(f"MR_URL={data.get(\"web_url\", \"\")}")' > mr.env
  artifacts:
    reports:
      dotenv: mr.env

reply_mr_link:
  stage: notify
  needs: ["create_merge_request", "parse_agent_command"]
  rules:
    - if: '$MR_URL && $AGENT_ISSUE_IID && $GITLAB_TOKEN'
  script:
    - |
      curl --fail --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --data-urlencode "body=Draft MR created.

MR: ${MR_URL}
task_id: ${TASK_ID}
target_file: ${TARGET_FILE}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues/${AGENT_ISSUE_IID}/notes"

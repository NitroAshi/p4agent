stages:
  - parse
  - task
  - quality
  - diff
  - mr
  - notify

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/'
    - when: never

default:
  image: python:3.12
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends git curl
    - pip install --disable-pip-version-check uv
    - uv sync --all-extras

variables:
  P4AGENT_LLM_ENABLED: "true"
  P4AGENT_LLM_PROVIDER: "openai"
  P4AGENT_LLM_MODEL: "glm-4.7"
  P4AGENT_LLM_FALLBACK_TO_RULES: "true"

quality:
  stage: quality
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"'
  script:
    - ./scripts/ci/quality_checks.sh --with-coverage

parse_agent_command:
  stage: parse
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/'
  script:
    - uv run python -m app.agent_pr_command --comment "$AGENT_COMMAND" --output-file agent.env --output-format dotenv
  artifacts:
    reports:
      dotenv: agent.env

reply_invalid_command:
  stage: notify
  needs: ["parse_agent_command"]
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/ && $AGENT_ISSUE_IID && $GITLAB_TOKEN'
  script:
    - |
      if [[ "${VALID:-false}" == "true" ]]; then
        echo "Command is valid; skip invalid-command reply."
        exit 0
      fi
      cat <<EOF | ./scripts/ci/post_gitlab_issue_note.sh
      I could not parse this command.

      Reason: ${ERROR_MESSAGE}

      Use this format:
      /agent-pr append_hello_agent_comment ./aaa.txt
      EOF

run_task:
  stage: task
  needs: ["parse_agent_command"]
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/'
  script:
    - |
      if [[ "${VALID:-false}" != "true" ]]; then
        echo "Skip task run because command is invalid: ${ERROR_MESSAGE:-unknown}"
        printf '{\"status\":\"skipped\",\"reason\":\"invalid command\",\"error\":\"%s\"}\n' "${ERROR_MESSAGE:-unknown}" > run_task_output.json
        mkdir -p run_task_artifacts
        printf '%s\n' "${TARGET_FILE:-}" > run_task_artifacts/target_file_path.txt
        exit 0
      fi
      echo "Running command: uv run p4agent-cli --task-id \"$TASK_ID\" --target-file \"$TARGET_FILE\""
      run_output="$(uv run p4agent-cli --task-id "$TASK_ID" --target-file "$TARGET_FILE")"
      echo "Task output:"
      printf '%s\n' "$run_output"
      printf '%s\n' "$run_output" > run_task_output.json
      mkdir -p run_task_artifacts
      if [[ -f "$TARGET_FILE" ]]; then
        cp -- "$TARGET_FILE" run_task_artifacts/target_file_snapshot
        printf '%s\n' "$TARGET_FILE" > run_task_artifacts/target_file_path.txt
      else
        echo "Target file not found after task run: $TARGET_FILE" > run_task_artifacts/target_file_missing.txt
      fi
  artifacts:
    paths:
      - run_task_output.json
      - run_task_artifacts/

quality_checks_agent:
  stage: quality
  needs: ["run_task", "parse_agent_command"]
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/'
  script:
    - |
      if [[ "${VALID:-false}" != "true" ]]; then
        echo "Skip quality checks because command is invalid."
        exit 0
      fi
      ./scripts/ci/quality_checks.sh

detect_changes:
  stage: diff
  needs: ["quality_checks_agent", "parse_agent_command"]
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/'
  script:
    - |
      if [[ "${VALID:-false}" != "true" ]]; then
        echo "CHANGED=false" > change.env
        exit 0
      fi
      if git diff --quiet; then
        echo "CHANGED=false" > change.env
      else
        echo "CHANGED=true" > change.env
      fi
  artifacts:
    reports:
      dotenv: change.env

reply_no_changes:
  stage: notify
  needs: ["detect_changes", "parse_agent_command"]
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/ && $AGENT_ISSUE_IID && $GITLAB_TOKEN'
  script:
    - |
      if [[ "${VALID:-false}" != "true" || "${CHANGED:-false}" == "true" ]]; then
        echo "Skip no-change reply."
        exit 0
      fi
      cat <<EOF | ./scripts/ci/post_gitlab_issue_note.sh
      Task ran successfully, but no file changes were detected.

      task_id: ${TASK_ID}
      target_file: ${TARGET_FILE}
      EOF

create_merge_request:
  stage: mr
  needs: ["detect_changes", "parse_agent_command"]
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/ && $GITLAB_TOKEN'
  script:
    - |
      if [[ "${VALID:-false}" != "true" || "${CHANGED:-false}" != "true" ]]; then
        echo "Skip merge request creation."
        echo "MR_URL=" > mr.env
        exit 0
      fi
      ./scripts/ci/create_gitlab_mr.sh
  artifacts:
    reports:
      dotenv: mr.env

reply_mr_link:
  stage: notify
  needs: ["create_merge_request", "parse_agent_command"]
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/ && $AGENT_ISSUE_IID && $GITLAB_TOKEN'
  script:
    - |
      if [[ -z "${MR_URL:-}" ]]; then
        echo "Skip MR link reply because MR_URL is empty."
        exit 0
      fi
      cat <<EOF | ./scripts/ci/post_gitlab_issue_note.sh
      Draft MR created.

      MR: ${MR_URL}
      task_id: ${TASK_ID}
      target_file: ${TARGET_FILE}
      EOF

reply_execution_failure:
  stage: notify
  needs: ["parse_agent_command"]
  when: on_failure
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/ && $AGENT_ISSUE_IID && $GITLAB_TOKEN'
  script:
    - |
      if [[ "${VALID:-false}" != "true" ]]; then
        exit 0
      fi
      cat <<EOF | ./scripts/ci/post_gitlab_issue_note.sh
      The command was parsed, but execution failed during task run or quality checks.

      task_id: ${TASK_ID}
      target_file: ${TARGET_FILE}
      run: ${CI_PIPELINE_URL}
      EOF

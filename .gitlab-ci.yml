stages:
  - quality
  - parse
  - task
  - diff
  - mr
  - notify

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/'
    - when: never

default:
  image: python:3.12
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends git curl
    - pip install --disable-pip-version-check uv
    - uv sync --all-extras

variables:
  P4AGENT_LLM_ENABLED: "true"
  P4AGENT_LLM_PROVIDER: "openai"
  P4AGENT_LLM_MODEL: "glm-4.7"
  P4AGENT_LLM_FALLBACK_TO_RULES: "true"

quality:
  stage: quality
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"'
  script:
    - ./scripts/ci/quality_checks.sh --with-coverage

parse_agent_command:
  stage: parse
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/'
  script:
    - uv run python -m app.agent_pr_command --comment "$AGENT_COMMAND" --output-file agent.env --output-format dotenv
  artifacts:
    reports:
      dotenv: agent.env

reply_invalid_command:
  stage: notify
  needs: ["parse_agent_command"]
  rules:
    - if: '$VALID != "true" && $AGENT_ISSUE_IID && $GITLAB_TOKEN'
  script:
    - |
      cat <<EOF | ./scripts/ci/post_gitlab_issue_note.sh
      I could not parse this command.

      Reason: ${ERROR_MESSAGE}

      Use this format:
      /agent-pr append_hello_agent_comment ./aaa.txt
      EOF

run_task:
  stage: task
  needs: ["parse_agent_command"]
  rules:
    - if: '$VALID == "true"'
  script:
    - uv run p4agent-cli --task-id "$TASK_ID" --target-file "$TARGET_FILE"

quality_checks_agent:
  stage: quality
  needs: ["run_task"]
  rules:
    - if: '$VALID == "true"'
  script:
    - ./scripts/ci/quality_checks.sh

detect_changes:
  stage: diff
  needs: ["quality_checks_agent", "parse_agent_command"]
  rules:
    - if: '$VALID == "true"'
  script:
    - |
      if git diff --quiet; then
        echo "CHANGED=false" > change.env
      else
        echo "CHANGED=true" > change.env
      fi
  artifacts:
    reports:
      dotenv: change.env

reply_no_changes:
  stage: notify
  needs: ["detect_changes", "parse_agent_command"]
  rules:
    - if: '$VALID == "true" && $CHANGED != "true" && $AGENT_ISSUE_IID && $GITLAB_TOKEN'
  script:
    - |
      cat <<EOF | ./scripts/ci/post_gitlab_issue_note.sh
      Task ran successfully, but no file changes were detected.

      task_id: ${TASK_ID}
      target_file: ${TARGET_FILE}
      EOF

create_merge_request:
  stage: mr
  needs: ["detect_changes", "parse_agent_command"]
  rules:
    - if: '$VALID == "true" && $CHANGED == "true" && $GITLAB_TOKEN'
  script:
    - ./scripts/ci/create_gitlab_mr.sh
  artifacts:
    reports:
      dotenv: mr.env

reply_mr_link:
  stage: notify
  needs: ["create_merge_request", "parse_agent_command"]
  rules:
    - if: '$MR_URL && $AGENT_ISSUE_IID && $GITLAB_TOKEN'
  script:
    - |
      cat <<EOF | ./scripts/ci/post_gitlab_issue_note.sh
      Draft MR created.

      MR: ${MR_URL}
      task_id: ${TASK_ID}
      target_file: ${TARGET_FILE}
      EOF

reply_execution_failure:
  stage: notify
  needs: ["parse_agent_command"]
  when: on_failure
  rules:
    - if: '$AGENT_COMMAND =~ /^\/agent-pr\s+/ && $AGENT_ISSUE_IID && $GITLAB_TOKEN'
  script:
    - |
      if [[ "${VALID:-false}" != "true" ]]; then
        exit 0
      fi
      cat <<EOF | ./scripts/ci/post_gitlab_issue_note.sh
      The command was parsed, but execution failed during task run or quality checks.

      task_id: ${TASK_ID}
      target_file: ${TARGET_FILE}
      run: ${CI_PIPELINE_URL}
      EOF
